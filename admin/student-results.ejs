<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Results / Students Results Preview</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="../../admin/assets/img/logo.png" rel="icon">
  <link href="../../admin/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
    rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="../../admin/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../../admin/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../../admin/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="../../admin/assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="../../admin/assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="../../admin/assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="../../admin/assets/vendor/simple-datatables/style.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="../../admin/assets/css/style.css" rel="stylesheet">

  <script src="../../school/js/jquery-3.2.1.min.js"></script>

</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
      <a href="/admin/<%= school_obj.name %>/dashboard" class="logo d-flex align-items-center">
        <img src="../../admin/assets/img/logo.png" alt="">
        <span class="d-none d-lg-block">Orbital Admin</span>
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div><!-- End Logo -->

    <div class="d-flex align-items-center justify-content-between tex">
      <span class="d-none d-lg-block">
        <div class="pad">Manage the contents of your school Website and Database</div>
      </span>
    </div>



    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">

        <li class="nav-item dropdown pe-3">
          <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
            <img src="<%= school_obj.logo %>" alt="Profile">
            <span class="d-none d-md-block dropdown-toggle ps-2">
              <%= school_obj.name %>
            </span>
          </a><!-- End Profile Iamge Icon -->

          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
            <li class="dropdown-header">
              <h6>
                <%= school_obj.name %>
              </h6>
              <span>Admin Account</span>
            </li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li>
              <a class="dropdown-item d-flex align-items-center" href="#changePasswordModal" data-bs-toggle="modal">
                <i class="bi bi-grid"></i>
                <span>Change Login Password</span>
              </a>
            </li>
            <li>
              <a class="dropdown-item d-flex align-items-center" href="/admin">
                <i class="bi bi-box-arrow-right"></i>
                <span>Sign Out</span>
              </a>
            </li>

          </ul><!-- End Profile Dropdown Items -->
        </li><!-- End Profile Nav -->

      </ul>
    </nav><!-- End Icons Navigation -->

  </header><!-- End Header -->

  <!-- ======= Sidebar ======= -->
  <aside id="sidebar" class="sidebar">

    <ul class="sidebar-nav" id="sidebar-nav">

      <li class="nav-item">
        <a class="nav-link collapsed" href="/admin/<%=school_obj.name%>/dashboard">
          <i class="bi bi-grid"></i>
          <span>Dashboard</span>
        </a>
      </li><!-- End Dashboard Nav -->

      <li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#forms-nav" data-bs-toggle="collapse" href="#">
          <i class="bi bi-cloud"></i><span>Website</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="forms-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
          <li>
            <a href="school-info">
              <i class="bi bi-circle"></i><span>School Information</span>
            </a>
          </li>
          <li>
            <a href="upcoming-news">
              <i class="bi bi-circle"></i><span>Upcoming news and Events</span>
            </a>
          </li>
          <li>
            <a href="fees-info">
              <i class="bi bi-circle"></i><span>Fees Payment Details</span>
            </a>
          </li>
        </ul>
      </li><!-- End Website Nav -->

      <li class="nav-item">
        <a class="nav-link collapsed" data-bs-target="#tables-nav" data-bs-toggle="collapse" href="#">
          <i class="bi bi-people"></i><span>Students</span><i class="bi bi-chevron-down ms-auto"></i>
        </a>
        <ul id="tables-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
          <li>
            <a href="student-info">
              <i class="bi bi-circle"></i><span>Students Information</span>
            </a>
          </li>
          <li>
            <a href="student-fees">
              <i class="bi bi-circle"></i><span>Students Fees Status</span>
            </a>
          </li>
          <a href="student-register">
            <i class="bi bi-circle"></i><span>E-Register</span>
          </a>
      </li>
    </ul>
    </li><!-- End Students Nav -->

    <li class="nav-item">
      <a class="nav-link " data-bs-target="#components-nav" data-bs-toggle="collapse" href="#">
        <i class="bi bi-layout-text-window-reverse"></i><span>Results</span><i class="bi bi-chevron-down ms-auto"></i>
      </a>
      <ul id="components-nav" class="nav-content collapse show" data-bs-parent="#sidebar-nav">
        <li>
          <a href="blue-print">
            <i class="bi bi-circle"></i><span>Assessments Structure</span>
          </a>
        </li>
        <li>
          <a href="continous-assessments">
            <i class="bi bi-circle"></i><span>Continous Assessment</span>
          </a>
        </li>
        <li>
          <a href="student-results" class="active">
            <i class="bi bi-circle"></i><span>Students Results Preview</span>
          </a>
        </li>
      </ul>
    </li><!-- End Results Nav -->

    <li class="nav-item">
      <a class="nav-link collapsed" data-bs-target="#charts-nav" data-bs-toggle="collapse" href="#">
        <i class="bi bi-person-check"></i><span>Parents</span><i class="bi bi-chevron-down ms-auto"></i>
      </a>
      <ul id="charts-nav" class="nav-content collapse " data-bs-parent="#sidebar-nav">
        <li>
          <a href="parents">
            <i class="bi bi-circle"></i><span>Feedbacks</span>
          </a>
        </li>
      </ul>
    </li><!-- End Parents Nav -->

    <li class="nav-heading">References</li>

    <li class="nav-item">
      <a class="nav-link collapsed" href="sessions">
        <i class="bi bi-collection"></i>
        <span>Sessions</span>
      </a>
    </li><!-- End Sessions Page Nav -->

    <li class="nav-item">
      <a class="nav-link collapsed" href="classes">
        <i class="bi bi-menu-button-wide"></i>
        <span>Classes</span>
      </a>
    </li><!-- End Classes Page Nav -->

    <li class="nav-item">
      <a class="nav-link collapsed" href="subjects">
        <i class="bi bi-book"></i>
        <span>Subjects</span>
      </a>
    </li><!-- End Subjects Page Nav -->

    </ul>

  </aside><!-- End Sidebar-->
  <main id="main" class="main">

    <div class="pagetitle">
      <h1>Students Results Preview</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Home</a></li>
          <li class="breadcrumb-item">Results</li>
          <li class="breadcrumb-item active">Students Results Preview</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <% if(sessions_data.length!=0 && class_data.length !=0) { %>
      <!-- REFERENCE SELECTOR -->
      <div class="card">
        <div class="internal">
          <div class="rrr">
            <div class="row md-3">
              <label class="col-sm-5 col-form-label">Session</label>
              <div class="col-sm-8">
                <select class="form-select" aria-label="Session" id="sessionSelector" onchange="updateData()">
                  <% for(var i=0; i < sessions_data.length; i++){ %>
                    <option value="<%= sessions_data[i].name %>">
                      <%= sessions_data[i].name %>
                    </option>
                    <% } %>
                </select>
              </div>
            </div>

            <div class="row md-1">
              <label class="col-sm-5 col-form-label">Term</label>
              <div class="col-sm-8">
                <select class="form-select" aria-label="Term" id="termSelector" onchange="updateData()">
                  <option value="first" selected>First</option>
                  <option value="second">Second</option>
                  <option value="third">Third</option>
                </select>
              </div>
            </div>

            <div class="row md-1">
              <label class="col-sm-5 col-form-label">Class</label>
              <div class="col-sm-8">
                <select class="form-select" aria-label="Class" id="classSelector" onchange="updateData()">
                  <% for(var i=0; i < class_data.length; i++){ %>
                    <option value="<%= class_data[i].name %>">
                      <%= class_data[i].name %>
                    </option>
                    <% } %>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
      <section class="section">
        <div class="row">
          <div class="col-md-12 offset-md-0">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">View Students Results</h5>
                <!-- Table with hoverable rows -->
                <table class="table table-hover" id="myTable">
                  <thead>
                    <tr>
                      <th scope="col">S/N</th>
                      <th scope="col">Name</th>
                      <th scope="col">Gender</th>
                      <th scope="col">PIN</th>
                      <th scope="col">Class</th>
                    </tr>
                  </thead>
                  <tbody>

                  </tbody>
                </table>
                <!-- End Table with hoverable rows -->

              </div>
            </div>

          </div>
        </div>
      </section>
      <% } else { %>
        <div class="text-center">
          <p>You have not completed the required steps to setup your admin panel hence you will not be able to preview
            students results from the database. Please follow the steps highlighted below:</p><br>
          <ul>
            <li>Create a session</li>
            <li>Set term starting and Ending dates in the Students >> E-register section</li>
            <li>Create Classes</li>
            <li>Add <b>all</b> subjects to classes</li>
            <li>Add students to class from Student >> Student Information</li>
          </ul>
          <i>Please take note that if you do not follow the above instructions in the order stated above, you could
            possibly encounter
            problems while working with our system.</i>
        </div>
        <% } %>
  </main><!-- End #main -->
  <!-- Change Password Modal -->
  <div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Change Password</h5>
          <button class="close" data-bs-dismiss="modal"
            style="border: none; background-color: transparent;">&times;</button>
        </div>
        <div class="modal-body">
          <form class="row g-3 needs-validation" method="post" action="/admin/<%= school_obj.name %>/changePassword"
            id="passwordForm">
            <div class="col-12">
              <label for="yourName" class="form-label">Old Password</label>
              <input type="text" name="oldPass" class="form-control" id="old-psw" required>
              <div class="invalid-feedback">Please, enter your old password</div>
            </div>
            <div class="col-12">
              <label for="yourName" class="form-label">New Password</label>
              <input type="text" name="newPass" class="form-control" id="new-psw" required>
              <div class="invalid-feedback">Please, the new password</div>
            </div>
            <button type="submit" id="btnSubmit" style="display: none;"></button>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="create" onclick="$('#btnSubmit').click()">Change</button>
        </div>

      </div>
    </div>
  </div>
  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div class="copyright">
      &copy; Powered by <strong><span>Orbital Node 2023</span></strong>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="../../admin/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../../admin/assets/vendor/quill/quill.min.js"></script>
  <script src="../../admin/assets/vendor/tinymce/tinymce.min.js"></script>

  <script
    src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

  <!-- Template Main JS File -->
  <script src="../../admin/assets/js/main.js"></script>

  <script>
    function updateData() {
      $.LoadingOverlay("show");
      $.ajax({
        url: '/admin/<%= school_obj.name %>/getStudents',
        type: 'POST',
        data: JSON.stringify({
          session: $("#sessionSelector").val(),
          class: $("#classSelector").val(),
          term: $("#termSelector").val(),
        }),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {
          var payload = data.payload;

          payload.sort(function (a, b) {
            return b.total - a.total;
          });
          var content = '';
          if (payload < 1) {
            $('#myTable tbody').html('Students not added yet');
            return;
          }

          payload.forEach((item, index) => {
            content += `
                   <tr data-url="/admin/<%= school_obj.name %>/result/${item.class}/${item.name}">
                     <th scope="row">${index + 1}</th>
                     <td>${item.name}</td>
                     <td>${item.gender}</td>
                     <td>${item.pin}</td>
                     <td>${item.class}</td>
                   </tr>`
          });
          $('#myTable tbody').html(content);
          update();
        },
        complete: function () {
          $.LoadingOverlay("hide", true);
        },
      });
      return;
    }

    function update() {
      var rows = document.getElementsByTagName('tr'),
        url;

      for (var i = 0, len = rows.length; i < len; i++) {
        if (i === 0) { continue; }
        rows[i].onclick = function () {
          uri = this.getAttribute('data-url');
          window.location = uri;
        };
      }
    }

    $(document).ready(function () {
      updateData();
      $("#passwordForm").submit(function (event) {
        event.preventDefault();
        var form = $(this);
        var action = form.attr('action');
        var formData = form.serialize();
        $.ajax({
          type: "POST",
          url: action,
          data: formData,
          success: function (data) {
            if (data.success) {
              $(".modal-body").html("<h5>Your password was changes successfully.");
              setTimeout(function () {
                window.location.href = "/admin";
              }, 2000);
            } else {
              alert("The Old Password you entered is invalid! Try again.");
              setTimeout(function () {
                location.reload();
              }, 2000);
            }
          },
          error: function (error) {
            alert('Oops! Somerhing happened. Pls try again later');
          }
        });
      });

    });

    var rows = document.getElementsByTagName('tr'),
      url;
    for (var i = 0, len = rows.length; i < len; i++) {
      if (i === 0) { continue; }
      rows[i].onclick = function () {
        uri = this.getAttribute('data-url');
        window.location = uri;
      };
    }
  </script>

</body>

</html>